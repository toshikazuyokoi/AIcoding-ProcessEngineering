# 品質ゲート: テスト設計品質チェック

## 目的・スコープ

STEP 4（テスト設計）完了時に、テスト設計の完全性・有効性・自動化準備状況を確認し、STEP 5（実装計画）へ移行して良いかを判定する。欠落や非現実的なカバレッジ目標を残したまま実装計画に進むことを防止する。

## Source Mapping
- @docs-theory/theory/quality-gate-detailed-specifications-v1.3.md § Test Design
- @docs-theory/theory/quality-assurance-integration.md
- @docs-theory/theory/reproducibility-validation-plan.md

## チェック項目

### 1. テスト戦略・範囲の妥当性
- [ ] `docs-agent/test-design/strategy.md` が存在し、更新日と版数が明記されている
- [ ] テストレベル（単体・結合・E2E）が定義され、目的と手法が明文化されている
- [ ] 測定指標（カバレッジ、失敗率、フレーク率）が定義されている
- [ ] 実行環境（CI、ブラウザ/Nodeバージョン、DBモード）が定義されている

### 2. テスト対象一覧の網羅性
- [ ] `docs-agent/test-design/targets.md` が存在し、対象/レベル/優先度/担当が表で管理されている
- [ ] 主要コンポーネント（Service/Controller/Repository/API）がすべて紐づいている
- [ ] リスクの高い領域（認証、永続化、並行処理、外部I/F）が明示的に含まれている

### 3. 単体テストケース設計の完全性
- [ ] 正常系・異常系・境界値が設計されている
- [ ] 例外設計（throw/エラーコード）の検証が含まれている
- [ ] モック/スタブ/フェイクの方針と対象が明記されている（例：外部API・DB）

### 4. 結合テストケース設計の完全性
- [ ] 主要APIのシナリオ（前提・手順・期待結果）が表で設計されている
- [ ] 認証/認可・トランザクション・整合性の検証が含まれている
- [ ] 負荷/並列要求の簡易検証シナリオが定義されている（任意）

### 5. E2Eテストシナリオ設計の妥当性
- [ ] 主要ユーザーフローのハッピーパスが網羅されている
- [ ] 代表的なエラーフロー/バリデーション失敗が網羅されている
- [ ] 初期データ準備・クリーンアップ手順が明記されている

### 6. テストデータ設計
- [ ] `docs-agent/test-design/test-cases.md` または分割ファイルにデータ仕様が含まれている
- [ ] データファクトリ/ビルダー（例: TestDataFactory）が設計されている
- [ ] 冪等性確保（固定ID/Seed、時刻固定、リセット手順）が定義されている
- [ ] 機微情報のマスキング/ダミー化方針が定義されている

### 7. トレーサビリティ
- [ ] 要件⇔テスト（単体/結合/シナリオ）の対応表が存在する
- [ ] 非機能要件に対するテスト（性能/セキュリティ/可用性等）の対応が示されている

### 8. 自動化・CI準備
- [ ] npmスクリプトが定義されている（例：`test`, `test:coverage`, `e2e`）
- [ ] カバレッジ閾値（行/分岐）が設定されている（Jest等の設定）
- [ ] Lint/型チェックとテストがCIパイプラインで直列または並列実行される計画

## 品質基準

### 定量的基準
| 項目 | 基準値 | 測定方法 |
|------|--------|----------|
| 単体テスト 行カバレッジ | 90%以上 | Jest/coverage レポート |
| 単体テスト 分岐カバレッジ | 85%以上 | Jest/coverage レポート |
| 結合テスト APIカバレッジ | 100% | 主要APIに対するケース網羅表 |
| E2E 主要シナリオ網羅率 | 100% | 設計済み主要シナリオ通過 |

### 定性的基準
- テストは独立・再現可能（データ初期化と固定化が可能）
- 期待結果が検証可能（明確なアサーションと一致条件）
- 可読性・保守性（命名、Arrange/Act/Assert、共通化）

## チェック手順

### 1. 文書存在・形式確認
```bash
# テスト設計文書の存在確認
ls docs-agent/test-design/
# 期待: strategy.md, targets.md, test-cases.md

# カバレッジ設定の確認（例: Jest）
grep -n "coverageThreshold" -n jest*.config.* package.json || true
```

### 2. ケース網羅性レビュー（抜粋テンプレート）
```markdown
# ケース網羅表（抜粋）
| 対象 | レベル | 正常 | 異常 | 境界 | 例外 | 備考 |
|------|--------|------|------|------|------|------|
| UserService.createUser | 単体 | ✅ | ✅ | ✅ | ✅ | 既存メール重複 |
| Users API POST /api/users | 結合 | ✅ | ✅ | - | ✅ | 409重複 |
| ユーザー登録フロー | E2E | ✅ | ✅ | - | - | Playwright |
```

### 3. テストデータ/モック方針確認
- データファクトリーの有無とAPI
- 固定Seed/固定時刻の方針（例: `jest.useFakeTimers()`、`seedrandom`）
- 外部I/Fのモック戦略（HTTP/メール/キュー等）

### 4. トレーサビリティ確認（例）
```markdown
# 要件⇔テスト トレーサビリティ（例）
| 要件ID | 単体 | 結合 | E2E |
|--------|------|------|-----|
| FR-001: ログイン | AuthService.* | POST /api/login | ログイン→ダッシュボード |
| NFR-002: 性能 | - | APIスループット簡易 | 主要フロー測定 |
```

## 不合格時の対応

### 軽微（1-2日で修正可能）
- 欠落ケース追加、データファクトリーの整備
- カバレッジ設定・閾値の明確化、フレーク対策の追記

### 重大（再設計が必要）
- テスト戦略未定義、主要シナリオ未設計、冪等性未確保
- 非現実的なカバレッジ目標／測定不能な指標

## 合格判定

### 合格条件
- 全チェック項目が✅
- 定量的基準をすべて満たす
- 自動化準備（スクリプト/設定/CI計画）が確認済み

### 合格時の次アクション
- STEP 5（実装計画）への移行承認
- テスト設計ベースライン確定（変更管理開始）

## 品質ゲート記録

### チェック実行記録
| 実行日 | チェック担当者 | 結果 | 指摘事項数 | 対応状況 |
|--------|----------------|------|------------|----------|
| 2025-01-28 | QAリード | 合格 | 0件 | 完了 |

### 最終判定
- 判定結果: 合格 ✅
- 判定日: 2025-01-28
- 判定者: QAリード
- 次STEP移行: 承認

