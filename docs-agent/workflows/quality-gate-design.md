# 品質ゲート: 設計品質チェック

## 目的・スコープ

STEP 3（詳細設計）完了時に、設計の完全性・一貫性・実装可能性を確認し、STEP 4（テスト設計）へ移行して良いかを判定する。欠落や矛盾を残したままテスト設計へ進むことを防止する。

## Source Mapping
- @docs-theory/theory/quality-gate-detailed-specifications-v1.3.md § 設計
- @docs-theory/theory/process-engineering-v1.3-complete-definition.md
- @docs-theory/theory/ai-coding-development-process-v1.3-deliverable-flow.md

## チェック項目

### 1. クラス設計の完全性
- [ ] クラス依存関係図（Mermaid）が作成されている
- [ ] 主要クラスの責務が一意である（SRP）
- [ ] 属性・メソッドが表に整理されている
- [ ] 例外・エラー条件が設計に反映されている

### 2. インターフェース仕様の品質
- [ ] メソッドの引数・戻り値・例外が明確
- [ ] Nullable/Optionalの扱いが明確
- [ ] バージョニング・互換性方針が定義
- [ ] TypeScriptシグネチャが型安全

### 3. データベース設計の整合性
- [ ] ER/テーブル定義が存在
- [ ] 制約（PK/FK/Unique/Index）が妥当
- [ ] 正規化方針が明確（必要に応じて非正規化の根拠あり）
- [ ] 代表的クエリ性能への配慮

### 4. API設計の完全性
- [ ] エンドポイント一覧が網羅
- [ ] リクエスト/レスポンススキーマ定義
- [ ] 認証・認可の方針が明記
- [ ] エラーコード体系が定義

### 5. 非機能要件の反映
- [ ] 性能・可用性・セキュリティ等が設計に反映
- [ ] ログ/監視/トレーシングの設計
- [ ] テスタビリティ（DI、疎結合）の配慮

### 6. トレーサビリティ
- [ ] 要件→設計の対応が表で追跡可能
- [ ] 設計→テスト（予定）の見通しがある

## 品質基準

### 定量的基準
| 項目 | 基準値 | 測定方法 |
|------|--------|----------|
| 設計文書完成度 | 100% | 必須図表・表の存在確認 |
| IF仕様網羅率 | 100% | 定義済みメソッドの表/型定義有無 |
| DB整合性検証 | 0エラー | スキーマ静的チェック/制約確認 |
| Mermaid記法検証 | 100% | Mermaidブロックの構文エラーなし |

### 定性的基準
- 責務の一貫性が保たれている（凝集度高/結合度低）
- 実装現実性が高い（期間・スキル・ツールで実現可能）
- 保守性・拡張性・テスタビリティの観点を満たす

## チェック手順

### 1. 文書存在・形式確認
```bash
# 詳細設計文書の存在確認
grep -n "# STEP 3" -n docs-agent/workflows/step3-detailed-design.md
ls docs-agent/detailed-design/
# - classes.md
# - interfaces.md

# Mermaidブロック検出（構文チェックはレンダリング時に実施）
grep -n "```mermaid" docs-agent/workflows/step3-detailed-design.md
```

### 2. クラス・IF仕様レビュー
```markdown
# 抜粋テンプレート
| クラス名 | 責務 | 属性 | メソッド | 依存関係 |
|----------|------|------|----------|----------|
| User | ユーザー管理 | id, name, email | updateName() | Email |

| I/F名 | メソッド | 引数 | 戻り値 | 例外 |
|-------|----------|------|--------|------|
| ITaskRepository | findById | id: string | Task\|null | RepositoryError |
```

### 3. DB設計レビュー
- PK/FK/Index/Uniqueの有無確認
- 代表クエリに対するインデックス計画確認
- 参照整合性とON DELETE/UPDATE方針の確認

### 4. API設計レビュー
- 主要CRUD/APIのリソース・パス・メソッド対応
- エラーレスポンスの一貫性（コード/メッセージ）
- 認証・認可・レート制限の記載

### 5. トレーサビリティ確認
```markdown
# 要件→設計 対応表例
| 要件ID | 設計要素 | 備考 |
|--------|----------|------|
| FR-001 | UserService.createUser | UC-001対応 |
| NFR-002 | Cache層/インデックス方針 | 性能要件 |
```

## プロトタイプ/スパイク（任意）
```typescript
// 型安全性の事前検証（例）
interface CreateUserDto { name: string; email: string; }
interface IUserRepository { findByEmail(email: Email): Promise<User|null>; save(u: User): Promise<User>; }
```

## 不合格時の対応

### 軽微（2-3日で修正可能）
- 表・図の欠落補完、用語統一、例外規定の追記

### 重大（再設計が必要）
- 責務分割の破綻、テスタビリティ不十分、非機能未反映
- DB正規化/整合性に大穴、APIセキュリティ欠如

## 合格判定

### 合格条件
- 全チェック項目が✅
- 定量的基準を全て満たす
- 実装可能性に重大リスクなし

### 合格時の次アクション
- STEP 4（テスト設計）への移行承認
- 設計ベースライン確定（変更管理開始）

## 品質ゲート記録

### チェック実行記録
| 実行日 | チェック担当者 | 結果 | 指摘事項数 | 対応状況 |
|--------|----------------|------|------------|----------|
| 2025-01-28 | 設計レビュアー | 合格 | 0件 | 完了 |