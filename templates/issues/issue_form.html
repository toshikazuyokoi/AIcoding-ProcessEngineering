{% extends 'base.html' %}
{% load static %}

{% block title %}
  {% if mode == 'edit' %}チケット編集{% else %}チケット作成{% endif %} - Issue Tracker
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/issues.css' %}">
<style>
/* SC-006 チケット作成・編集画面専用スタイル */
.form-section {
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.form-section-title {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: #495057;
  border-bottom: 2px solid #007bff;
  padding-bottom: 0.5rem;
}

.required-field label::after {
  content: ' *';
  color: #dc3545;
  font-weight: bold;
}

.form-help {
  font-size: 0.875rem;
  color: #6c757d;
  margin-top: 0.25rem;
}

.form-actions {
  background: #f8f9fa;
  padding: 1.5rem;
  border-radius: 0.375rem;
  border: 1px solid #dee2e6;
}

@media (max-width: 768px) {
  .assignment-grid {
    display: block;
  }
  .assignment-grid > div {
    margin-bottom: 1rem;
  }
}

.assignment-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}
</style>
{% endblock %}

{% block breadcrumb %}
<!-- BREADCRUMB パンくずナビ -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{% url 'dashboard' %}">
        <i class="bi bi-house"></i>ホーム
      </a>
    </li>
    <li class="breadcrumb-item">
      <a href="{% url 'issue_list' %}">
        <i class="bi bi-bug"></i>チケット一覧
      </a>
    </li>
    {% if mode == 'edit' %}
      <li class="breadcrumb-item">
        <a href="{% url 'issue_detail' issue.id %}">
          チケット詳細 #{{ issue.id }}
        </a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        編集
      </li>
    {% else %}
      <li class="breadcrumb-item active" aria-current="page">
        新規作成
      </li>
    {% endif %}
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- FORM_HEADER フォームヘッダー -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="mb-0">
          {% if mode == 'edit' %}
            <i class="bi bi-pencil-square me-2"></i>チケット編集
            <small class="text-muted ms-2">#{{ issue.id }}</small>
          {% else %}
            <i class="bi bi-plus-circle me-2"></i>新規チケット作成
          {% endif %}
        </h2>
      </div>
    </div>
  </div>

  <form method="post" novalidate>
    {% csrf_token %}
    
    <!-- エラーメッセージ表示 -->
    {% if form.non_field_errors %}
      <div class="alert alert-danger" role="alert">
        {% for error in form.non_field_errors %}
          {{ error }}
        {% endfor %}
      </div>
    {% endif %}

    <!-- BASIC_INFO 基本情報入力 -->
    <div class="form-section">
      <h3 class="form-section-title">
        <i class="bi bi-info-circle me-2"></i>基本情報
      </h3>
      
      <!-- タイトル -->
      <div class="mb-3 required-field">
        {{ form.title.label_tag }}
        {{ form.title }}
        {% if form.title.errors %}
          <div class="invalid-feedback d-block">
            {{ form.title.errors.0 }}
          </div>
        {% endif %}
        <div class="form-help">チケットの概要を簡潔に記述してください（5文字以上）</div>
      </div>

      <!-- 説明 -->
      <div class="mb-3 required-field">
        {{ form.description.label_tag }}
        {{ form.description }}
        {% if form.description.errors %}
          <div class="invalid-feedback d-block">
            {{ form.description.errors.0 }}
          </div>
        {% endif %}
        <div class="form-help">詳細な内容、再現手順、期待される動作などを記述してください（10文字以上）</div>
      </div>

      <!-- 優先度 -->
      <div class="mb-3 required-field">
        {{ form.priority.label_tag }}
        {{ form.priority }}
        {% if form.priority.errors %}
          <div class="invalid-feedback d-block">
            {{ form.priority.errors.0 }}
          </div>
        {% endif %}
        <div class="form-help">チケットの重要度を選択してください</div>
      </div>
    </div>

    <!-- ASSIGNMENT 割り当て情報 -->
    <div class="form-section">
      <h3 class="form-section-title">
        <i class="bi bi-people me-2"></i>割り当て情報
      </h3>
      
      <div class="assignment-grid">
        <!-- 担当者 -->
        <div class="mb-3">
          {{ form.assigned_to.label_tag }}
          {{ form.assigned_to }}
          {% if form.assigned_to.errors %}
            <div class="invalid-feedback d-block">
              {{ form.assigned_to.errors.0 }}
            </div>
          {% endif %}
          <div class="form-help">チケットの担当者を選択してください（任意）</div>
        </div>

        <!-- 締切日 -->
        <div class="mb-3">
          {{ form.due_date.label_tag }}
          {{ form.due_date }}
          {% if form.due_date.errors %}
            <div class="invalid-feedback d-block">
              {{ form.due_date.errors.0 }}
            </div>
          {% endif %}
          <div class="form-help">完了予定日を設定してください（任意）</div>
        </div>
      </div>

      <!-- プロジェクト -->
      <div class="mb-3">
        {{ form.project.label_tag }}
        {{ form.project }}
        {% if form.project.errors %}
          <div class="invalid-feedback d-block">
            {{ form.project.errors.0 }}
          </div>
        {% endif %}
        <div class="form-help">このチケットが属するプロジェクトを選択してください</div>
      </div>
    </div>

    <!-- ATTACHMENTS 添付ファイル（将来拡張用） -->
    <div class="form-section">
      <h3 class="form-section-title">
        <i class="bi bi-paperclip me-2"></i>添付ファイル
      </h3>
      <div class="text-muted">
        <i class="bi bi-info-circle me-1"></i>
        添付ファイル機能は今後のバージョンで実装予定です。
      </div>
    </div>

    <!-- FORM_ACTIONS フォームアクション -->
    <div class="form-actions">
      <div class="d-flex gap-3">
        <button type="submit" class="btn btn-primary">
          {% if mode == 'edit' %}
            <i class="bi bi-check-circle me-1"></i>更新
          {% else %}
            <i class="bi bi-plus-circle me-1"></i>作成
          {% endif %}
        </button>
        <a href="{% if mode == 'edit' %}{% url 'issue_detail' issue.id %}{% else %}{% url 'issue_list' %}{% endif %}" class="btn btn-outline-secondary">
          <i class="bi bi-x-circle me-1"></i>キャンセル
        </a>
      </div>
      
      <div class="mt-3">
        <small class="text-muted">
          <i class="bi bi-asterisk"></i>
          <strong>*</strong> 印の項目は必須入力です。
        </small>
      </div>
    </div>
  </form>
</div>
{% endblock %}