{% extends 'base.html' %}
{% load static %}

{% block title %}通知一覧 - Issue Tracker{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/issues.css' %}">
<style>
/* SC-008 通知一覧画面専用スタイル */
.notification-header {
  background: #f8f9fa;
  border-left: 4px solid #17a2b8;
  padding: 1rem;
  margin-bottom: 1.5rem;
}

.filter-card {
  border: none;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  margin-bottom: 1.5rem;
}

.notification-card {
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  margin-bottom: 1rem;
  transition: all 0.2s ease-in-out;
}

.notification-card:hover {
  box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
  transform: translateY(-1px);
}

.notification-card.unread {
  border-left: 4px solid #007bff;
  background: #f8f9ff;
}

.notification-card.read {
  background: #fff;
  opacity: 0.85;
}

.notification-icon {
  font-size: 1.5rem;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 1rem;
}

.notification-icon.unread {
  background: #007bff;
  color: white;
}

.notification-icon.read {
  background: #e9ecef;
  color: #6c757d;
}

.notification-content {
  flex: 1;
}

.notification-meta {
  font-size: 0.875rem;
  color: #6c757d;
  margin-bottom: 0.5rem;
}

.notification-message {
  color: #212529;
  line-height: 1.6;
  margin-bottom: 0.5rem;
}

.notification-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.stats-card {
  border: none;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

@media (max-width: 768px) {
  .notification-card .d-flex {
    flex-direction: column;
  }
  .notification-icon {
    margin-right: 0;
    margin-bottom: 0.5rem;
    align-self: flex-start;
  }
}
</style>
{% endblock %}

{% block breadcrumb %}
<!-- BREADCRUMB パンくずナビ -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{% url 'dashboard' %}">
        <i class="bi bi-house"></i>ホーム
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">
      通知一覧
    </li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- NOTIF_HEADER 通知ヘッダー -->
  <div class="notification-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="mb-2">
          <i class="bi bi-bell-fill me-2"></i>通知一覧
        </h2>
        <div class="d-flex align-items-center gap-3">
          <span class="badge bg-primary">全 {{ total_notifications }} 件</span>
          <span class="badge bg-warning">未読 {{ unread_notifications }} 件</span>
        </div>
      </div>
      <div class="d-flex gap-2">
        {% if unread_notifications > 0 %}
          <button class="btn btn-outline-info" onclick="markAllAsRead()">
            <i class="bi bi-check-all me-1"></i>全て既読
          </button>
        {% endif %}
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i>戻る
        </a>
      </div>
    </div>
  </div>

  <!-- 統計情報カード -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card stats-card">
        <div class="card-body text-center">
          <h4 class="mb-0 text-info">{{ total_notifications }}</h4>
          <small class="text-muted">全通知</small>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stats-card">
        <div class="card-body text-center">
          <h4 class="mb-0 text-warning">{{ unread_notifications }}</h4>
          <small class="text-muted">未読</small>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stats-card">
        <div class="card-body text-center">
          <h4 class="mb-0 text-success">{{ read_notifications }}</h4>
          <small class="text-muted">既読</small>
        </div>
      </div>
    </div>
  </div>

  <!-- NOTIF_FILTERS 通知フィルター -->
  <div class="card filter-card">
    <div class="card-header">
      <h5 class="card-title mb-0">
        <i class="bi bi-funnel me-2"></i>フィルター・検索
      </h5>
    </div>
    <div class="card-body">
      <form method="get" class="row g-3">
        <!-- 未読フィルター -->
        <div class="col-md-3">
          <label for="unread_only" class="form-label">表示</label>
          <select name="unread_only" id="unread_only" class="form-select">
            <option value="">全ての通知</option>
            <option value="true" {% if unread_only == 'true' %}selected{% endif %}>未読のみ</option>
          </select>
        </div>
        
        <!-- 日付フィルター（作成日から） -->
        <div class="col-md-3">
          <label for="date_from" class="form-label">作成日（開始）</label>
          <input type="date" name="date_from" id="date_from" class="form-control" value="{{ date_from }}">
        </div>
        
        <!-- 日付フィルター（作成日まで） -->
        <div class="col-md-3">
          <label for="date_to" class="form-label">作成日（終了）</label>
          <input type="date" name="date_to" id="date_to" class="form-control" value="{{ date_to }}">
        </div>
        
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary me-2">
            <i class="bi bi-search me-1"></i>絞り込み
          </button>
          <a href="{% url 'notification_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-clockwise me-1"></i>リセット
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- NOTIFICATIONS_LIST 通知一覧 -->
  <div class="row">
    <div class="col-12">
      {% if page_obj %}
        {% for notification in page_obj %}
          <div class="notification-card {% if notification.is_read %}read{% else %}unread{% endif %}">
            <div class="card-body">
              <div class="d-flex">
                <!-- 通知アイコン -->
                <div class="notification-icon {% if notification.is_read %}read{% else %}unread{% endif %}">
                  <i class="bi bi-{% if notification.is_read %}check-circle{% else %}bell{% endif %}"></i>
                </div>
                
                <!-- 通知内容 -->
                <div class="notification-content">
                  <div class="notification-meta">
                    <span class="me-3">
                      <i class="bi bi-calendar me-1"></i>{{ notification.created_at|date:"Y年m月d日 H:i" }}
                    </span>
                    {% if not notification.is_read %}
                      <span class="badge bg-primary">未読</span>
                    {% endif %}
                  </div>
                  
                  <div class="notification-message">
                    {{ notification.message|linebreaks }}
                  </div>
                  
                  {% if not notification.is_read %}
                    <div class="notification-actions">
                      <form method="post" action="{% url 'notification_mark_read' notification.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-primary">
                          <i class="bi bi-check me-1"></i>既読にする
                        </button>
                      </form>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-center py-5">
          <i class="bi bi-bell text-muted" style="font-size: 4rem;"></i>
          <h4 class="text-muted mt-3">通知がありません</h4>
          <p class="text-muted">現在表示する通知はありません。</p>
          <a href="{% url 'dashboard' %}" class="btn btn-primary">
            <i class="bi bi-house me-1"></i>ダッシュボードに戻る
          </a>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- PAGINATION ページネーション -->
  {% if page_obj.has_other_pages %}
    <div class="row mt-4">
      <div class="col-12">
        <nav aria-label="通知一覧ページネーション">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1{% if unread_only %}&unread_only={{ unread_only }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                  <i class="bi bi-chevron-double-left"></i>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if unread_only %}&unread_only={{ unread_only }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                  <i class="bi bi-chevron-left"></i>
                </a>
              </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <li class="page-item active">
                  <span class="page-link">{{ num }}</span>
                </li>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ num }}{% if unread_only %}&unread_only={{ unread_only }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">{{ num }}</a>
                </li>
              {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if unread_only %}&unread_only={{ unread_only }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                  <i class="bi bi-chevron-right"></i>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if unread_only %}&unread_only={{ unread_only }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                  <i class="bi bi-chevron-double-right"></i>
                </a>
              </li>
            {% endif %}
          </ul>
        </nav>
        
        <p class="text-center text-muted">
          {{ page_obj.paginator.count }} 件中 {{ page_obj.start_index }}〜{{ page_obj.end_index }} 件を表示
        </p>
      </div>
    </div>
  {% endif %}
</div>

<script>
function markAllAsRead() {
  if (confirm('全ての通知を既読にしますか？')) {
    // TODO: 全既読化APIを実装した際に追加
    alert('この機能は今後実装予定です。');
  }
}
</script>
{% endblock %}